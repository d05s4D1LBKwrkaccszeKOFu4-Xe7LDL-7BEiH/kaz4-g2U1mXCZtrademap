<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>Карта Казахстана – ФАО</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css" />
<style>
    html,body{margin:0;padding:0;height:100%}
    #map{position:relative;width:100%;height:100vh;z-index:1;background:#f8fbff}
    
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }

    /* Рубрикатор слева */
    .metrics-control-left{
        position:absolute;top:80px;left:10px;background:white;padding:10px;
        border-radius:10px;box-shadow:0 6px 25px rgba(0,0,0,.15);z-index:1000;
        display:flex;flex-direction:column;gap:6px;width:190px;
    }
    .metrics-control-left button{
        padding:8px 12px;background:#f8f9fa;border:2px solid #ced4da;border-radius:8px;
        cursor:pointer;font-size:12.5px;text-align:left;transition:all .3s;
    }
    .metrics-control-left button:hover{background:#e9ecef;transform:translateX(3px)}
    .metrics-control-left button.active{
        background:#1976D2;color:white;border-color:#1565c0;
        box-shadow:0 0 15px rgba(25,118,210,.4);
    }

    /* Правый верхний угол */
    .top-right-controls{
        position:absolute;top:10px;right:10px;background:white;padding:12px 16px;
        border-radius:10px;box-shadow:0 4px 20px rgba(0,0,0,.15);z-index:1000;
        display:flex;flex-direction:column;gap:5px;
    }
    
    .akmola-link {
        display:flex;align-items:center;gap:8px;color:#1976D2;
        text-decoration:none;font-size:14px;padding:8px 12px;background:#e3f2fd;
        border-radius:8px;transition:.3s;font-weight: 600;
        margin-bottom: 10px;
        justify-content: space-between;
    }
    .akmola-link:hover{background:#bbdefb}
    .akmola-link::after { content: "↗"; font-size: 16px; line-height: 1; }
    .top-right-controls label{ display:flex;align-items:center;gap:8px;cursor:pointer;font-size:13px; padding: 2px 0; }

    #mapTransitionLoader img { animation: pulse 1.8s infinite ease-in-out; }
    @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.12); } }

    /* Легенда */
    .legend{
        position:absolute;bottom:25px;right:20px;background:white;padding:10px;border-radius:8px;
        box-shadow:0 4px 20px rgba(0,0,0,.15);font-size:11.5px;
        max-width:210px;z-index:999;line-height:1.4;border:1px solid #e0e0e0;
    }
    .legend-title{margin-bottom:8px;font-size:12px;color:#333;font-weight: bold;}
    .legend-item{display:flex;align-items:center;gap:8px;margin:4px 0}
    .legend-color{width:24px;height:16px;border:1px solid #aaa}

    /* Стили попапов */
    .leaflet-popup-content-wrapper{
        background:#fff !important;box-shadow:0 5px 25px rgba(0,0,0,.3)!important;
        padding:0!important;border-radius:8px !important;overflow: hidden;
    }
    .leaflet-popup-content{margin:0!important;padding:0!important; width: 100% !important;}
    .leaflet-popup-tip { background: #fff; }

    .popup-header{
        background:#1976D2;color:white;padding:12px 15px;font-size:15px;font-weight: bold;border-bottom: 1px solid #1565c0;
    }
    .popup-header small { display: block; font-weight: normal; font-size: 12px; opacity: 0.9; margin-top: 2px; }

    .popup-body { padding:0; font-size: 11.5px; color: #333; }
    .popup-section { padding: 10px 15px; border-bottom: 1px solid #eee; }
    .section-title { font-weight: bold; color: #1976D2; font-size: 11px; text-transform: uppercase; margin-bottom: 6px; }
    .popup-row{display:flex;justify-content:space-between;margin:3px 0; align-items: center;}
    .popup-label{color:#555;}
    .popup-value{font-weight:700;color:#1976D2; text-align: right;}

    /* Аккордеон */
    .acc-header{
        cursor:pointer; background:#e3f2fd; padding:6px 10px; border-radius:4px;
        display:flex;justify-content:space-between;align-items:center;
        font-size:11.5px; color:#1565c0; font-weight: bold; margin-top: 5px; transition: background .2s;
    }
    .acc-header:hover{background:#bbdefb}
    .acc-content{ max-height:0;overflow-y:auto;transition:max-height .4s ease; background: #fff; }
    .acc-open .acc-content{max-height:250px; border-top: 1px solid #eee; padding-top: 5px;}
    .acc-open .acc-arrow { transform: rotate(180deg); }

    /* Баланс */
    .balance-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; padding: 10px 15px; }
    .balance-col { min-width: 0; }
    .balance-flow-item { margin-bottom: 8px; padding-bottom: 6px; border-bottom: 1px solid #eee; page-break-inside: avoid; }
    .balance-markup { display: block; font-weight: bold; margin-top: 2px; font-size: 10.5px; }
    .markup-green { color: #2e7d32; }
    .markup-yellow { color: #f9a825; }
    .markup-orange { color: #ef6c00; }
    .markup-red { color: #c62828; }

    #mapTransitionLoader{
        position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(255,255,255,0.85);
        display:none;align-items:center;justify-content:center;z-index:9999;flex-direction:column;color:#333;
    }
</style>
</head>
<body>

<div id="map"></div>

<div class="metrics-control-left">
    <button class="metric-btn active" data-metric="retail">Розничная торговля – продовольственные товары</button>
    <button class="metric-btn" data-metric="wholesale">Оптовая торговля – продовольственные товары</button>
    <button class="metric-btn" data-metric="population">Численность населения</button>
    <button class="metric-btn" data-metric="susn">Социально уязвимые слои населения – СУСН, чел</button>
    <button class="metric-btn" data-metric="queue">Очередники МИО</button>
    <button class="metric-btn" data-metric="balance">Прод. баланс</button>
</div>

<div class="top-right-controls">
    <a href="https://d05s4D1LBKwrkaccszeKOFu4-Xe7LDL-7BEiH.github.io/akmtrademapVa0HP07Ko/" class="akmola-link" data-loader-img="gluster_2020.png">Акмолинская область</a>
    <a href="https://d05s4D1LBKwrkaccszeKOFu4-Xe7LDL-7BEiH.github.io/jMs7k0stanaykQeCY2bE8/" class="akmola-link" data-loader-img="kostanay_logo.png">г. Костанай</a>
    
    <label><input type="checkbox" id="storageToggle"> <span style="color:#1976D2">Овощехранилища</span></label>
    <label><input type="checkbox" id="fairsToggle">   <span style="color:#2e7d32">Ярмарки</span></label>
</div>

<div class="legend" id="legend"></div>

<div id="mapTransitionLoader">
    <img id="loaderImage" src="gluster_2020.png" alt="Загрузка" style="width:150px;">
    <p style="margin-top:20px;font-size:22px; color:white; font-weight:600;">Переход к карте...</p>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>

<script>
// --- 1. Инициализация карты ---
const map = L.map('map', {
    center: [48.0, 66.0],
    zoom: 5,
    zoomControl: false
});
L.control.zoom({ position: 'topright' }).addTo(map);

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {attribution: '© OpenStreetMap'}).addTo(map);

// Панели
map.createPane('oblastPane'); map.getPane('oblastPane').style.zIndex = 450; map.getPane('oblastPane').style.pointerEvents = 'none';
map.createPane('highlightPane'); map.getPane('highlightPane').style.zIndex = 440;

// Глобальные переменные
let currentMetric = 'retail';
let activeLayerGroup = null;
let districtsLayer, balanceClickableLayer, storageLayer, fairsLayer, oblastBorderLayer;
let highlightedLayer = null;

const warehouseIcon = L.icon({iconUrl:'warehouse.png', iconSize:[18,18], iconAnchor:[9,18], popupAnchor:[0,-16]});
const stallIcon     = L.icon({iconUrl:'stall.png',     iconSize:[18,18], iconAnchor:[9,18], popupAnchor:[0,-16]});

const priceColumns = [
  'Мука пшеничная высшего сорта и 1 сорта', 'Хлеб ржаной', 'Хлеб ржано-пшеничный', 'Макаронные изделия',
  'Крупа гречневая', 'Крупа рисовая', 'Картофель', 'Морковь', 'Лук репчатый', 'Капуста',
  'Огурцы', 'Томаты', 'Свекла', 'Яблоки', 'Мясо птицы', 'Говядина', 'Баранина', 'Свинина',
  'Молоко коровье', 'Творог', 'Сыр', 'Яйца куриные', 'Масло растительное', 'Сахар', 'Чай', 'Соль'
];

// --- КОНФИГ ---
const config = { 
    retail: { field: 'Розничная торговля – продовольственные товары', title: 'Розничная торговля' }, 
    wholesale: { field: 'Оптовая торговля – продовольственные товары', title: 'Оптовая торговля' }, 
    population: { field: 'Численность населения', title: 'Население' }, 
    susn: { field: 'СУСН (человек)', title: 'СУСН' },
    // Теперь это работает со слоем Balance (области)
    queue: { field: 'estate_demand', title: 'Очередники МИО' },
    balance: { field: null, title: 'Продовольственный баланс' } 
};

// --- ЛЕГЕНДА ---
const legendData = {
    retail:     { colors: ['#ffffcc','#ffeda0','#fed976','#feb24c','#fd8d3c','#fc4e2a','#e31a1c','#b10026'], labels: ['6 тыс — 850 тыс','850 тыс — 2,5 млн','2,5 млн — 6 млн','6 млн — 12,5 млн','12,5 млн — 50 млн','50 млн+'] },
    wholesale:  { colors: ['#ffffd4','#fee391','#fec44f','#fe9929','#ec7014','#cc4c02','#8c2d04'], labels: ['50 тыс — 1 млн','1 млн — 5 млн','5 млн — 15 млн','15 млн — 50 млн','50 млн — 150 млн','150 млн+'] },
    population: { colors: ['#f7fbff','#deebf7','#c6dbef','#9ecae1','#6baed6','#4292c6','#2171b5','#08519c'], labels: ['5 тыс — 15 тыс','15 тыс — 30 тыс','30 тыс — 50 тыс','50 тыс — 100 тыс','100 тыс — 200 тыс','200 тыс+'] },
    susn:       { colors: ['#ffd7de', '#fb6a6a', '#de2d26', '#a50f15', '#67000d', '#3b0007'], labels: ['до 650','650—2 тыс.','2 тыс.—4 тыс.','4 тыс.—7 тыс.','7 тыс.—12 тыс.','12 тыс. +'] },
    // Фиолетовый градиент для областей
    queue:      { colors: ['#f2f0f7', '#dadaeb', '#bcbddc', '#9e9ac8', '#756bb1', '#54278f'], labels: ['до 20 тыс', '20 тыс — 26 тыс', '26 тыс — 32 тыс', '32 тыс — 38 тыс', '38 тыс — 45 тыс', '45 тыс +'] }
};

function toTitleCase(str) {
    if (!str) return '';
    return str.toLowerCase().replace(/(?:^|\s|-)\S/g, function(a) { return a.toUpperCase(); });
}

function formatNum(num) {
    if (!num) return '0';
    if (num >= 1e9) return (num / 1e9).toFixed(2) + ' млрд';
    if (num >= 1e6) return (num / 1e6).toFixed(2) + ' млн';
    if (num >= 1000) return (num / 1000).toFixed(0) + ' тыс';
    return num;
}

function getColor(value, metric) {
    if (!value) return '#eee';
    const breaks = { 
        retail: [850000,2500000,6000000,12500000,50000000], 
        wholesale: [1000000,5000000,15000000,50000000,150000000], 
        population: [15000,30000,50000,100000,200000], 
        susn: [650,2000,4000,7000,12000],
        queue: [20000, 26000, 32000, 38000, 45000]
    };
    const b = breaks[metric];
    const cols = legendData[metric].colors;
    
    if (value < b[0]) return cols[0];
    if (value < b[1]) return cols[1];
    if (value < b[2]) return cols[2];
    if (value < b[3]) return cols[3];
    if (value < b[4]) return cols[4];
    return cols[cols.length - 1];
}

// --- СТИЛИ ---

// 1. Районы (для метрик retail, wholesale, population, susn)
function districtStyle(f) {
    const val = f.properties[config[currentMetric].field];
    return { fillColor: getColor(val, currentMetric), weight: 1, opacity: 1, color: 'white', fillOpacity: 0.85 };
}

// 2. Области (для balance и queue)
function balanceStyle(f) {
    // Если режим очереди - используем градиент
    if (currentMetric === 'queue') {
        const val = f.properties['estate_demand'];
        return {
            fillColor: getColor(val, 'queue'),
            weight: 1,
            opacity: 1,
            color: 'white',
            fillOpacity: 0.85,
            dashArray: '' // Без пунктира
        };
    }
    // Если режим баланса - серый пунктир
    return {
        fillColor: '#e0e0e0', fillOpacity: 0.6, color: '#333', weight: 1.5, dashArray: '5, 5', opacity: 1
    };
}

// --- Интерактивность ---
function highlightFeature(e) {
    const layer = e.target;
    if (highlightedLayer && activeLayerGroup) { activeLayerGroup.resetStyle(highlightedLayer); }
    layer.setStyle({ weight: 3, color: '#33ffff', dashArray: '', fillOpacity: 0.9 });
    if (!L.Browser.ie && !L.Browser.opera && !L.Browser.edge) { layer.bringToFront(); }
    highlightedLayer = layer;
}

function hoverFeature(e) {
    const layer = e.target;
    if (layer !== highlightedLayer) {
        if (currentMetric === 'balance') { layer.setStyle({ weight: 2.5, color: '#000', fillOpacity: 0.75 }); } 
        else { layer.setStyle({ weight: 2, color: '#666', fillOpacity: 0.95 }); }
    }
}

function resetHover(e) {
    const layer = e.target;
    if (layer !== highlightedLayer && activeLayerGroup) { activeLayerGroup.resetStyle(layer); }
}

function onEachFeature(feature, layer) {
    layer.on({ mouseover: hoverFeature, mouseout: resetHover, click: highlightFeature });
}

// --- ПОПАПЫ ---

// 1. Попап районов
function generatePopup(p) {
    const districtName = toTitleCase(p.ADM_2_RUS || p.ADM2_EN || 'Район');
    const oblastName = toTitleCase(p.ADM_1_RUS || p.ADM1_EN || 'Область');
    
    const retail = p['Розничная торговля – продовольственные товары'] || 0;
    const wholesale = p['Оптовая торговля – продовольственные товары'] || 0;
    const pop = p['Численность населения'] || 0;
    const susnFam = p['СУСН (семей)'] || 0;
    const susnPeop = p['СУСН (человек)'] || 0;
    const salary = p['Всего'] || 0;

    let priceRows = '';
    priceColumns.forEach(col => {
        let val = 0;
        for (let key in p) { if (key.includes(col)) { val = p[key]; break; } }
        if (val) { priceRows += `<tr><td>${col}</td><td style="text-align:right;color:#1976D2;font-weight:bold">${Number(val).toFixed(1)} т</td></tr>`; }
    });
    if (!priceRows) priceRows = '<tr><td colspan="2" style="text-align:center;color:#999">Нет данных</td></tr>';

    return `<div style="min-width: 340px;">
        <div class="popup-header">${districtName}<small>${oblastName}</small></div>
        <div class="popup-body">
            <div class="popup-section">
                <div class="section-title">ЭКОНОМИКА</div>
                <div class="popup-row"><span class="popup-label">Розн. торг. (прод.):</span><span class="popup-value">${formatNum(retail)}</span></div>
                <div class="popup-row"><span class="popup-label">Опт. торг. (прод.):</span><span class="popup-value">${formatNum(wholesale)}</span></div>
                <div class="popup-row"><span class="popup-label">Всего (з/п):</span><span class="popup-value">${formatNum(salary)}</span></div>
            </div>
            <div class="popup-section">
                <div class="section-title">НАСЕЛЕНИЕ</div>
                <div class="popup-row"><span class="popup-label">Численность:</span><span class="popup-value">${formatNum(pop)}</span></div>
                <div class="popup-row"><span class="popup-label">Кол-во семей / человек СУСН:</span><span class="popup-value">${susnFam} / ${susnPeop}</span></div>
            </div>
            <div style="padding: 0 15px 15px 15px;">
                <div class="acc-header" onclick="this.parentElement.classList.toggle('acc-open')">
                    НОРМА ПРОД. ОБЕСПЕЧЕНИЯ (ТОНН) <span class="acc-arrow">▼</span>
                </div>
                <div class="acc-content">
                    <table style="width:100%;border-collapse:collapse;font-size:11px;">${priceRows}</table>
                </div>
            </div>
        </div>
    </div>`;
}

// 2. ДИНАМИЧЕСКИЙ попап для ОБЛАСТЕЙ (Balance или Queue)
function getDynamicBalancePopup(feature) {
    const p = feature.properties;
    const oblastName = toTitleCase(p.ADM_1_RUS || p.ADM1_EN || 'Область');

    // Если режим Очереди - показываем статистику
    if (currentMetric === 'queue') {
        const estateDemand = p['estate_demand'] || 0;
        const estateRecieved = p['estate_recieved'] || 0;
        return `<div style="min-width:220px;">
            <div class="popup-header">${oblastName}</div>
            <div class="popup-body" style="padding:10px;">
                <div class="popup-row"><span class="popup-label">Очередники:</span><span class="popup-value">${formatNum(estateDemand)}</span></div>
                <div class="popup-row"><span class="popup-label">Получили жилье:</span><span class="popup-value">${formatNum(estateRecieved)}</span></div>
            </div>
        </div>`;
    }

    // Иначе режим Баланса - показываем потоки
    let items = [];
    for (const [product, rawValue] of Object.entries(p)) {
        if (['fid','ADM1_EN','ADM_1_RUS','Shape_Leng','Shape_Area', 'estate_demand', 'estate_recieved'].includes(product)) continue;
        if (!rawValue || typeof rawValue !== 'string' || !rawValue.trim()) continue;
        const regions = rawValue.split(';');
        let prodContent = '';
        regions.forEach(regStr => {
            regStr = regStr.trim();
            if (!regStr) return;
            const match = regStr.match(/^(.*?)\s*\((\d+(?:\.\d+)?)\)$/);
            if (match) {
                const regionName = match[1];
                const rawNum = match[2];
                const markupDisplay = rawNum.replace('.', ',');
                const colorClass = getMarkupClass(rawNum);
                prodContent += `<div style="margin-top:3px; line-height:1.2">${regionName}<span class="balance-markup ${colorClass}">Наценка: ${markupDisplay}%</span></div>`;
            } else { prodContent += `<div>${regStr}</div>`; }
        });
        if (prodContent) {
            items.push(`<div class="balance-flow-item"><div class="popup-label" style="font-weight:bold;color:#333;margin-bottom:2px;">${product}:</div><div style="padding-left:5px; font-size:11.5px;">${prodContent}</div></div>`);
        }
    }
    const mid = Math.ceil(items.length / 2);
    const leftCol = items.slice(0, mid).join('');
    const rightCol = items.slice(mid).join('');
    return `<div style="min-width:450px;"><div class="popup-header">${oblastName}</div><div class="popup-body"><div class="balance-grid"><div class="balance-col">${leftCol || '<i>Нет данных</i>'}</div><div class="balance-col">${rightCol}</div></div></div></div>`;
}

function getMarkupClass(val) {
    val = parseFloat(val);
    if (isNaN(val)) return '';
    if (val < 10) return 'markup-green';
    if (val < 50) return 'markup-yellow';
    if (val < 80) return 'markup-orange';
    return 'markup-red';
}

function storagePopup(p) {
    const resTV = p['Результат ТВ'];
    let tvBlock = '';
    if (resTV) {
        tvBlock = `<div style="margin-top:8px;"><div class="acc-header" onclick="this.parentElement.classList.toggle('acc-open')">Результат ТВ <span class="acc-arrow">▼</span></div><div class="acc-content" style="padding:8px; background:#f9f9f9; font-size:11px; line-height:1.4;">${resTV}</div></div>`;
    }
    return `<div style="min-width:280px;"><div class="popup-header" style="font-size:13px">${p['Наименование компании владельца']?.trim() || 'Овощехранилище'}</div><div style="padding:10px;font-size:11.5px;line-height:1.4"><div><b>Адрес:</b> ${p['Адрес'] || '-'}</div><div style="margin-top:4px"><b>Мощность:</b> ${p['Мощность овощехранилища, в тоннах'] || '-'} т</div>${tvBlock}</div></div>`;
}

function fairPopup(p) {
    return `<div style="min-width:240px;"><div class="popup-header" style="background:#2e7d32;font-size:13px">${p['Название'] || 'Ярмарка'}</div><div style="padding:10px;font-size:12px"><b>Адрес:</b><br>${p['Адрес'] || '-'}</div></div>`;
}

function updateLegend() {
    if (currentMetric === 'balance') {
        document.getElementById('legend').innerHTML = '<div class="legend-title">Продовольственный баланс</div><div>Кликните на область для просмотра потоков.</div>';
        return;
    }
    const d = legendData[currentMetric];
    let html = `<div class="legend-title">${config[currentMetric].title}</div>`;
    d.labels.forEach((l,i) => html += `<div class="legend-item"><div class="legend-color" style="background:${d.colors[i]}"></div>${l}</div>`);
    document.getElementById('legend').innerHTML = html;
}

// --- ЗАГРУЗКА ---
Promise.all([
    fetch('districts.geojson').then(r=>r.json()),
    fetch('balance.geojson').then(r=>r.json()),
    fetch('storages.geojson').then(r=>r.json()),
    fetch('fairs.geojson').then(r=>r.json())
]).then(([districts, balance, storages, fairs]) => {

    // Слой областей (используется для Balance и Queue)
    balanceClickableLayer = L.geoJSON(balance, {
        style: balanceStyle, // Стиль зависит от метрики
        onEachFeature: (f,l) => {
            onEachFeature(f,l); // Ховер/клик
            // Биндим функцию, чтобы контент попапа обновлялся динамически
            l.bindPopup(layer => getDynamicBalancePopup(layer.feature), {maxWidth: 500});
        }
    });

    // Слой районов (для Retail, Wholesale и т.д.)
    districtsLayer = L.geoJSON(districts, { 
        style: districtStyle, 
        onEachFeature: (f,l) => {
            onEachFeature(f,l);
            l.bindPopup(generatePopup(f.properties), {maxWidth: 400});
        }
    }).addTo(map);
    
    // Слой границ (для красоты поверх районов)
    oblastBorderLayer = L.geoJSON(balance, { 
        style: { weight: 1.5, color: '#333', dashArray: '5, 5', fill: false, pointerEvents: 'none' },
        interactive: false,
        pane: 'oblastPane'
    }).addTo(map);

    activeLayerGroup = districtsLayer; 

    storageLayer = L.geoJSON(storages, { 
        pointToLayer: (f,latlng) => L.marker(latlng,{icon:warehouseIcon}), 
        onEachFeature: (f,l) => l.bindPopup(storagePopup(f.properties)) 
    });
    fairsLayer = L.geoJSON(fairs, { 
        pointToLayer: (f,latlng) => L.marker(latlng,{icon:stallIcon}), 
        onEachFeature: (f,l) => l.bindPopup(fairPopup(f.properties)) 
    });

    document.getElementById('storageToggle').addEventListener('change', e => e.target.checked ? map.addLayer(storageLayer) : map.removeLayer(storageLayer));
    document.getElementById('fairsToggle').addEventListener('change', e => e.target.checked ? map.addLayer(fairsLayer) : map.removeLayer(fairsLayer));

    updateLegend();

}).catch(e => console.error('Ошибка загрузки:', e));

// --- ПЕРЕКЛЮЧЕНИЕ МЕТРИК ---
document.querySelectorAll('.metric-btn').forEach(btn => {
    btn.addEventListener('click', () => {
        if (highlightedLayer) {
            if (activeLayerGroup) activeLayerGroup.resetStyle(highlightedLayer);
            highlightedLayer = null;
        }

        document.querySelectorAll('.metric-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        currentMetric = btn.dataset.metric;

        // Если выбраны "Баланс" или "Очередники" — работаем со слоем ОБЛАСТЕЙ
        if (currentMetric === 'balance' || currentMetric === 'queue') {
            map.removeLayer(districtsLayer);
            if (!map.hasLayer(balanceClickableLayer)) map.addLayer(balanceClickableLayer);
            activeLayerGroup = balanceClickableLayer;
            
            // Границы областей (декор) скрываем, так как слой областей сам их рисует
            if (map.hasLayer(oblastBorderLayer)) map.removeLayer(oblastBorderLayer);
            
            // Обновляем стиль (серый или фиолетовый)
            balanceClickableLayer.setStyle(balanceStyle);
        } 
        // Иначе — работаем со слоем РАЙОНОВ
        else {
            if (map.hasLayer(balanceClickableLayer)) map.removeLayer(balanceClickableLayer);
            if (!map.hasLayer(districtsLayer)) map.addLayer(districtsLayer);
            activeLayerGroup = districtsLayer;
            
            // Возвращаем декоративные границы
            if (!map.hasLayer(oblastBorderLayer)) map.addLayer(oblastBorderLayer);
            
            districtsLayer.setStyle(districtStyle);
        }
        updateLegend();
    });
});

map.on('click', (e) => {
    if (e.originalEvent.target.classList.contains('leaflet-container')) {
        if (highlightedLayer && activeLayerGroup) {
            activeLayerGroup.resetStyle(highlightedLayer);
            highlightedLayer = null;
        }
    }
});

document.querySelectorAll('.akmola-link').forEach(link => {
    link.addEventListener('click', function(e) {
        e.preventDefault();
        const href = this.getAttribute('href');
        const loaderImg = this.getAttribute('data-loader-img') || 'gluster_2020.png';
        document.getElementById('loaderImage').src = loaderImg;
        document.getElementById('mapTransitionLoader').style.display = 'flex';
        setTimeout(() => { window.location.href = href; }, 500);
    });
});
</script>
</body>
</html>